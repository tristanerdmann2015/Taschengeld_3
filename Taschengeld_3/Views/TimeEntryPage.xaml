<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:behaviors="clr-namespace:Taschengeld_3.Behaviors"
             x:Class="Taschengeld_3.Views.TimeEntryPage"
             Title="Zeiten"
             Padding="10">

    <Grid RowDefinitions="Auto,Auto,*" RowSpacing="10">
        <!-- Row 0: New Entry Button -->
        <Button Grid.Row="0" 
                Text="+ Neue Zeiteintragung" 
                Clicked="OnNewEntry" 
                BackgroundColor="#4CAF50" 
                TextColor="White" 
                FontAttributes="Bold"
                Padding="12"/>

        <!-- Row 1: Edit Form (expandable, appears above list) -->
        <Grid Grid.Row="1" IsVisible="{Binding IsFormVisible}" RowDefinitions="*,Auto" RowSpacing="8" Padding="10" BackgroundColor="#F5F5F5" MinimumHeightRequest="240">
            
            <!-- Scrollable form content -->
            <ScrollView Grid.Row="0" VerticalScrollBarVisibility="Always" MinimumHeightRequest="200">
                <StackLayout Spacing="12">
                    <Label Text="Zeiteintragung bearbeiten" FontSize="14" FontAttributes="Bold" TextColor="#512BD4"/>
                    
                    <!-- Aufgabe mit "Bitte ausw채hlen" Hinweis -->
                    <StackLayout Spacing="4">
                        <StackLayout Orientation="Horizontal" Spacing="0">
                            <Label Text="Aufgabe *" FontSize="11" FontAttributes="Bold" TextColor="#333333"/>
                            <Label Text="{Binding TaskSelectionHint}" FontSize="11" TextColor="#999999"/>
                        </StackLayout>
                        <Picker x:Name="TaskPicker" 
                                ItemsSource="{Binding AvailableTasks}" 
                                SelectedItem="{Binding SelectedTask, Mode=TwoWay}" 
                                ItemDisplayBinding="{Binding Name}" 
                                SelectedIndexChanged="OnTaskPickerSelectedIndexChanged"
                                BackgroundColor="#E8EAF6"
                                TextColor="Black"
                                FontAttributes="Bold"
                                HeightRequest="45">
                            <Picker.Behaviors>
                                <behaviors:PickerHapticBehavior/>
                            </Picker.Behaviors>
                        </Picker>
                    </StackLayout>

                    <!-- Datum und Uhrzeit - nur sichtbar wenn Aufgabe ausgew채hlt -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10" IsVisible="{Binding IsTaskSelected}">
                        <StackLayout Grid.Column="0" Spacing="4">
                            <Label Text="Datum" FontSize="11" FontAttributes="Bold" TextColor="#333333"/>
                            <DatePicker Date="{Binding EntryDate, Mode=TwoWay}" 
                                        BackgroundColor="#E8EAF6" 
                                        TextColor="Black"
                                        HeightRequest="45">
                                <DatePicker.Behaviors>
                                    <behaviors:DatePickerHapticBehavior/>
                                </DatePicker.Behaviors>
                            </DatePicker>
                        </StackLayout>
                        
                        <StackLayout Grid.Column="1" Spacing="4">
                            <Label Text="Uhrzeit" FontSize="11" FontAttributes="Bold" TextColor="#333333"/>
                            <TimePicker Time="{Binding StartTime, Mode=TwoWay}" 
                                        BackgroundColor="#E8EAF6" 
                                        TextColor="Black"
                                        HeightRequest="45">
                                <TimePicker.Behaviors>
                                    <behaviors:TimePickerHapticBehavior/>
                                </TimePicker.Behaviors>
                            </TimePicker>
                        </StackLayout>
                    </Grid>

                    <!-- Dauer - nur sichtbar wenn Aufgabe ausgew채hlt -->
                    <StackLayout x:Name="DurationSection" Spacing="4" IsVisible="False">
                        <Label Text="Dauer (Stunden)" FontSize="11" FontAttributes="Bold" TextColor="#333333"/>
                        <Entry Placeholder="z.B. 2,5" 
                               Text="{Binding DurationInHoursText, Mode=TwoWay}" 
                               Keyboard="Text" 
                               PlaceholderColor="#999999" 
                               BackgroundColor="#E8EAF6" 
                               TextColor="Black"
                               FontAttributes="Bold"
                               HeightRequest="45">
                            <Entry.Behaviors>
                                <behaviors:EntryHapticBehavior/>
                            </Entry.Behaviors>
                        </Entry>
                    </StackLayout>

                    <!-- Anzahl - nur sichtbar wenn Aufgabe ausgew채hlt -->
                    <StackLayout x:Name="CountSection" Spacing="4" IsVisible="False">
                        <Label Text="Anzahl" FontSize="11" FontAttributes="Bold" TextColor="#333333"/>
                        <Entry Placeholder="z.B. 5" 
                               Text="{Binding CountText, Mode=TwoWay}" 
                               Keyboard="Text" 
                               PlaceholderColor="#999999" 
                               BackgroundColor="#E8EAF6" 
                               TextColor="Black"
                               FontAttributes="Bold"
                               HeightRequest="45">
                            <Entry.Behaviors>
                                <behaviors:EntryHapticBehavior/>
                            </Entry.Behaviors>
                        </Entry>
                    </StackLayout>
                </StackLayout>
            </ScrollView>
            
            <!-- Buttons always visible at bottom -->
            <Grid Grid.Row="1" ColumnDefinitions="*,*" ColumnSpacing="8">
                <Button Text="Speichern" Clicked="OnSaveEntry" BackgroundColor="#4CAF50" TextColor="White" FontAttributes="Bold" Padding="8"/>
                <Button Grid.Column="1" Text="Abbrechen" Clicked="OnClear" BackgroundColor="#E53935" TextColor="White" FontAttributes="Bold" Padding="8"/>
            </Grid>
        </Grid>

        <!-- Row 2: List of Time Entries -->
        <Grid Grid.Row="2" RowDefinitions="Auto,*" RowSpacing="5">
            <!-- Filter Section -->
            <StackLayout Grid.Row="0" Spacing="8" Padding="10" BackgroundColor="#F5F5F5">
                <Label Text="Filter" FontSize="12" FontAttributes="Bold"/>
                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                    <StackLayout Grid.Column="0" Spacing="2">
                        <Label Text="Von:" FontSize="10"/>
                        <DatePicker Date="{Binding FilterStartDate}"/>
                    </StackLayout>
                    <StackLayout Grid.Column="1" Spacing="2">
                        <Label Text="Bis:" FontSize="10"/>
                        <DatePicker Date="{Binding FilterEndDate}"/>
                    </StackLayout>
                </Grid>
                <Button Text="Filter anwenden" Clicked="OnApplyFilter" BackgroundColor="#2196F3" TextColor="White" Padding="8" FontAttributes="Bold"/>
            </StackLayout>

            <!-- Time Entries List -->
            <CollectionView Grid.Row="1" ItemsSource="{Binding TimeEntries}" SelectionMode="Single">
                <CollectionView.EmptyView>
                    <VerticalStackLayout Padding="20" Spacing="10" VerticalOptions="CenterAndExpand" HorizontalOptions="CenterAndExpand">
                        <Label Text="Keine Eintraege vorhanden" FontSize="14" FontAttributes="Bold" TextColor="Gray" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame BorderColor="#B0BEC5" Padding="12" Margin="0,6" CornerRadius="10" BackgroundColor="#FAFAFA" HasShadow="True">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <VerticalStackLayout Grid.Column="0" Spacing="4" VerticalOptions="Center">
                                    <Label Text="{Binding Task.Name, FallbackValue='Aufgabe nicht gefunden'}" FontSize="14" FontAttributes="Bold" TextColor="#263238"/>
                                    <StackLayout Orientation="Horizontal" Spacing="12">
                                        <Label Text="{Binding EntryDate, StringFormat='{0:dd.MM.yyyy}'}" FontSize="12" TextColor="#546E7A"/>
                                        <Label Text="{Binding StartTime, StringFormat='{0:hh\\:mm}'}" FontSize="12" TextColor="#546E7A"/>
                                    </StackLayout>
                                    <StackLayout Orientation="Horizontal" Spacing="16">
                                        <Label Text="{Binding DurationInHours, StringFormat='Dauer: {0:F1}h'}" FontSize="12" TextColor="#546E7A"/>
                                        <Label Text="{Binding Count, StringFormat='Anzahl: {0}'}" FontSize="12" TextColor="#546E7A"/>
                                        <Label Text="{Binding TotalPrice, StringFormat='Preis: {0:C}'}" FontSize="12" FontAttributes="Bold" TextColor="#4CAF50"/>
                                    </StackLayout>
                                </VerticalStackLayout>
                                
                                <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
                                    <ImageButton Source="edit_icon.png"
                                            Clicked="OnEditEntry" 
                                            CommandParameter="{Binding .}" 
                                            BackgroundColor="#512BD4" 
                                            WidthRequest="45" 
                                            HeightRequest="40" 
                                            Padding="8"
                                            CornerRadius="8"/>
                                    <ImageButton Source="delete_icon.png"
                                            Clicked="OnDeleteEntry" 
                                            CommandParameter="{Binding .}" 
                                            BackgroundColor="#E53935" 
                                            WidthRequest="45" 
                                            HeightRequest="40" 
                                            Padding="8"
                                            CornerRadius="8"/>
                                </HorizontalStackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
    </Grid>

</ContentPage>
