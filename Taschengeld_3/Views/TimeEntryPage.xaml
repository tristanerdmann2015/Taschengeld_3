<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Taschengeld_3.Views.TimeEntryPage"
             Title="Zeiten"
             Padding="10">

    <Grid RowDefinitions="Auto,Auto,*" RowSpacing="10">
        <!-- Row 0: New Entry Button -->
        <Button Grid.Row="0" 
                Text="+ Neue Zeiteintragung" 
                Clicked="OnNewEntry" 
                BackgroundColor="#4CAF50" 
                TextColor="White" 
                FontAttributes="Bold"
                Padding="12"/>

        <!-- Row 1: Edit Form (expandable, appears above list) -->
        <Grid Grid.Row="1" IsVisible="{Binding IsFormVisible}" RowDefinitions="*,Auto" RowSpacing="8" Padding="10" BackgroundColor="#F5F5F5" MinimumHeightRequest="240">
            
            <!-- Scrollable form content -->
            <ScrollView Grid.Row="0" VerticalScrollBarVisibility="Always" MinimumHeightRequest="200">
                <StackLayout Spacing="12">
                    <Label Text="Zeiteintragung bearbeiten" FontSize="14" FontAttributes="Bold" TextColor="#512BD4"/>
                    
                    <!-- Aufgabe -->
                    <StackLayout Spacing="2">
                        <Label Text="Aufgabe" FontSize="11" FontAttributes="Bold"/>
                        <Picker x:Name="TaskPicker" ItemsSource="{Binding AvailableTasks}" SelectedItem="{Binding SelectedTask, Mode=TwoWay}" ItemDisplayBinding="{Binding Name}" SelectedIndexChanged="OnTaskPickerSelectedIndexChanged"/>
                    </StackLayout>

                    <!-- Datum und Uhrzeit nebeneinander -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <StackLayout Grid.Column="0" Spacing="2">
                            <Label Text="Datum" FontSize="11" FontAttributes="Bold"/>
                            <DatePicker Date="{Binding EntryDate, Mode=TwoWay}"/>
                        </StackLayout>
                        
                        <StackLayout Grid.Column="1" Spacing="2">
                            <Label Text="Uhrzeit" FontSize="11" FontAttributes="Bold"/>
                            <TimePicker Time="{Binding StartTime, Mode=TwoWay}"/>
                        </StackLayout>
                    </Grid>

                    <!-- Dauer oder Anzahl (nur eine sichtbar) -->
                    <Frame BorderColor="#E0E0E0" Padding="12" CornerRadius="8">
                        <VerticalStackLayout Spacing="10">
                            <StackLayout x:Name="DurationSection" Spacing="2" IsVisible="False">
                                <Label Text="Dauer (Stunden)" FontSize="11" FontAttributes="Bold"/>
                                <Entry Placeholder="z.B. 2,5" Text="{Binding DurationInHours, Mode=TwoWay, StringFormat='{0:F2}'}" Keyboard="Numeric" PlaceholderColor="LightGray"/>
                            </StackLayout>

                            <StackLayout x:Name="CountSection" Spacing="2" IsVisible="False">
                                <Label Text="Anzahl" FontSize="11" FontAttributes="Bold"/>
                                <Entry Placeholder="z.B. 5" Text="{Binding Count, Mode=TwoWay}" Keyboard="Numeric" PlaceholderColor="LightGray"/>
                            </StackLayout>
                        </VerticalStackLayout>
                    </Frame>
                </StackLayout>
            </ScrollView>
            
            <!-- Buttons always visible at bottom -->
            <Grid Grid.Row="1" ColumnDefinitions="*,*" ColumnSpacing="8">
                <Button Text="Speichern" Clicked="OnSaveEntry" BackgroundColor="#4CAF50" TextColor="White" FontAttributes="Bold" Padding="8"/>
                <Button Grid.Column="1" Text="Abbrechen" Clicked="OnClear" BackgroundColor="#9E9E9E" TextColor="White" FontAttributes="Bold" Padding="8"/>
            </Grid>
        </Grid>

        <!-- Row 2: List of Time Entries -->
        <Grid Grid.Row="2" RowDefinitions="Auto,*" RowSpacing="5">
            <!-- Filter Section -->
            <StackLayout Grid.Row="0" Spacing="8" Padding="10" BackgroundColor="#F5F5F5">
                <Label Text="Filter" FontSize="12" FontAttributes="Bold"/>
                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                    <StackLayout Grid.Column="0" Spacing="2">
                        <Label Text="Von:" FontSize="10"/>
                        <DatePicker Date="{Binding FilterStartDate}"/>
                    </StackLayout>
                    <StackLayout Grid.Column="1" Spacing="2">
                        <Label Text="Bis:" FontSize="10"/>
                        <DatePicker Date="{Binding FilterEndDate}"/>
                    </StackLayout>
                </Grid>
                <Button Text="Filter anwenden" Clicked="OnApplyFilter" BackgroundColor="#2196F3" TextColor="White" Padding="8"/>
            </StackLayout>

            <!-- Time Entries List -->
            <CollectionView Grid.Row="1" ItemsSource="{Binding TimeEntries}" SelectionMode="Single">
                <CollectionView.EmptyView>
                    <VerticalStackLayout Padding="20" Spacing="10" VerticalOptions="CenterAndExpand" HorizontalOptions="CenterAndExpand">
                        <Label Text="Keine Eintraege vorhanden" FontSize="14" FontAttributes="Bold" TextColor="Gray" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <SwipeView.LeftItems>
                                <SwipeItems Mode="Reveal">
                                    <SwipeItem Text="Bearbeiten" Invoked="OnSwipeEdit" CommandParameter="{Binding .}" BackgroundColor="#2196F3" />
                                </SwipeItems>
                            </SwipeView.LeftItems>
                            <SwipeView.RightItems>
                                <SwipeItems Mode="Reveal">
                                    <SwipeItem Text="Loeschen" Invoked="OnSwipeDelete" CommandParameter="{Binding .}" BackgroundColor="#FF6B6B" />
                                </SwipeItems>
                            </SwipeView.RightItems>
                            <SwipeView.Content>
                                <Frame BorderColor="#B0BEC5" Padding="12" Margin="0,6" CornerRadius="10" BackgroundColor="#FAFAFA" HasShadow="True">
                                    <Grid ColumnDefinitions="*">
                                        <VerticalStackLayout Spacing="4">
                                            <Label Text="{Binding Task.Name, FallbackValue='Aufgabe nicht gefunden'}" FontSize="14" FontAttributes="Bold" TextColor="#263238"/>
                                            <StackLayout Orientation="Horizontal" Spacing="12">
                                                <Label Text="{Binding EntryDate, StringFormat='{0:dd.MM.yyyy}'}" FontSize="12" TextColor="#546E7A"/>
                                                <Label Text="{Binding StartTime, StringFormat='{0:hh\\:mm}'}" FontSize="12" TextColor="#546E7A"/>
                                            </StackLayout>
                                            <StackLayout Orientation="Horizontal" Spacing="16">
                                                <Label Text="{Binding DurationInHours, StringFormat='Dauer: {0:F1}h'}" FontSize="12" TextColor="#546E7A"/>
                                                <Label Text="{Binding Count, StringFormat='Anzahl: {0}'}" FontSize="12" TextColor="#546E7A"/>
                                                <Label Text="{Binding TotalPrice, StringFormat='Preis: {0:C}'}" FontSize="12" FontAttributes="Bold" TextColor="#4CAF50"/>
                                            </StackLayout>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Frame>
                            </SwipeView.Content>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
    </Grid>

</ContentPage>
